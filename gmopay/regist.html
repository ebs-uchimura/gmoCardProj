<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <title>決済URL発行</title>
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';">
  <link rel="stylesheet" href="css/index.css">
  <link rel="stylesheet" href="css/form.css">
</head>

<body>
  <h1 id="maintitle">決済URL発行</h1>
  <div id="wrapper" class="wrapper">
    <div class="pubwrapper">
      <div class="customerno">顧客番号</div>
      <input type="text" id="customerno" class="customerno" name="customerno" value=""
        onchange="sendCustomeNo()">&nbsp;&emsp;&emsp;
    </div>
    <div class="pubwrapper">
      <div class="customername">店舗名</div>
      <input type="text" id="customername" class="customername" name="customername" value="" readonly>&nbsp;様
    </div>
    <div class="pubwrapper">
      <div class="price">決済金額</div>
      <input type="text" id="price" class="price" name="price" value="">&nbsp;円&emsp;
    </div>
    <div class="pubwrapper">
      <button id="publish" class="button-g button-8 button-standard" onclick="publishpayURL()">URL発行</button>
    </div>
    <div class="pubwrapper">
      <input type="text" id="copyMe" class="urlbox" placeholder="" value="">
      <button type="button" id="btnCopy" class="button-g button-6 button-standard" onclick="copyURL()">
        コピー
      </button>
    </div>
    <div class="pubwrapper">
      <button type="button" id="btnClear" class="button-g button-4 button-standard" onclick="clearAll()">
        クリア
      </button>
    </div>
    <div class="pubwrapper">
      <button type="button" class="button-g button-6 button-standard" role="button" onclick="history.back()">トップへ戻る
    </div>
  </div>
  <footer>
    <p><small>&copy; 2024 Satsuma Ebisudo All Rights Reserved. </small></p>
  </footer>

  <script>
    // エラーフラグ
    let errorflg = false;
    // エラーメッセージ
    let errorArray = [];
    // タイトルdom
    const wrapperDom = document.getElementById('wrapper');
    // タイトルdom
    const titleDom = document.getElementById('maintitle');
    // 顧客番号
    const customernoDom = document.getElementById('customerno');
    // 店舗名
    const customernameDom = document.getElementById('customername');
    // 決済金額
    const priceDom = document.getElementById('price');
    // URL発行
    const publishDom = document.getElementById('publish');
    // コピー
    const copyMeDom = document.getElementById('copyMe');


    // 発行完了
    window.api.on('payment_publish_finish', arg => {
      // URL入力
      copyMeDom.value = arg;
    });

    // 顧客番号検索完了
    window.api.on('search_finish', arg => {
      // 顧客名入力
      customernameDom.value = arg;
    });

    // 顧客番号送信
    const sendCustomeNo = () => {
      try {
        console.log("customername check mode");
        // 配信名
        const customerno = customernoDom.value;
        // 顧客番号検索モード
        window.api.send("searchshop", customerno);

      } catch (e) {
        // エラー処理
        window.api.send("error", e);
      }
    }

    // 決済URL発行
    const publishpayURL = () => {
      try {
        console.log("pay publish mode");
        // 顧客番号
        const customerno = customernoDom.value;
        // 顧客名
        const customername = customernameDom.value;
        // 価格
        const price = priceDom.value;

        // エラー初期化
        errorflg = false

        /* バリデーション */
        // 顧客番号
        if (customerno == "") {
          errorArray.push("顧客番号が空欄です");
          errorflg = true;
        }
        // 顧客名
        if (customername == "") {
          errorArray.push("顧客名を選択してください");
          errorflg = true;
        }
        // 価格
        if (price == "") {
          errorArray.push("価格を選択してください");
          errorflg = true;
        }

        // エラーなし
        if (!errorflg) {
          // 送付内容
          const publishObj = {
            customerno: customerno, // 顧客番号
            customername: customername, // 顧客名
            price: price, // 価格
          }
          // 配信モード
          window.api.send("publish", publishObj);

        } else {
          // メッセージオプション
          const messageOption = {
            title: "エラー",
            message: errorArray.join("|"),
            type: "error",
          }
          // エラー表示
          window.api.send("showmessage", messageOption);
        }

      } catch (e) {
        // エラー処理
        window.api.send("error", e);
      }
    }

    // URLコピー
    const copyURL = () => {
      try {
        console.log("copyurl mode");
        // テキスト格納
        const text = copyMeDom.value

        // クリップボードなし
        if (navigator.clipboard == undefined) {
          // Windowsクリップボード使用
          window.clipboardData.setData("Text", text);

        } else {
          // navクリップボード
          navigator.clipboard.writeText(text);
        }

      } catch (e) {
        // エラー処理
        window.api.send("error", e);
      }
    }

    // クリア
    const clearAll = () => {
      try {
        console.log("clear mode");
        // フォーム初期化
        customernoDom.value = '';
        customernameDom.value = '';
        priceDom.value = '';
        copyMeDom.value = '';

      } catch (e) {
        // エラー処理
        window.api.send("error", e);
      }
    }
  </script>
</body>

</html>